# OmniWall 字幕功能说明

## 概述

OmniWall 现在支持完整的内嵌字幕和外挂字幕功能，使用 FFmpeg 进行底层字幕处理和提取。

## 功能特性

### 1. 字幕检测
- **内嵌字幕**: 自动检测视频文件中的内嵌字幕轨道
- **外挂字幕**: 自动扫描视频文件同目录下的外挂字幕文件
- **智能识别**: 支持多种字幕格式（SRT、VTT、ASS、SSA、SUB）

### 2. 字幕提取
- **FFmpeg 底层提取**: 使用 FFmpeg 提取内嵌字幕为 VTT 格式
- **智能缓存**: 提取的字幕文件会被缓存，避免重复提取
- **多种编解码器支持**: 支持 SUBRIP、ASS、SSA 等常见字幕格式

### 3. 字幕管理
- **字幕菜单**: 在播放器控制条中提供字幕选择菜单
- **实时切换**: 支持播放过程中切换不同字幕轨道
- **状态显示**: 显示当前选择的字幕和提取状态

## 技术实现

### 主进程 (main.js)

#### 字幕提取管理器 (SubtitleExtractor)
```javascript
class SubtitleExtractor {
  // 字幕提取和缓存管理
  extractSubtitle(videoPath, subtitleIndex, subtitleInfo)
  cleanupOldCache()
  clearCache()
}
```

#### 内嵌字幕检查
```javascript
async function checkEmbeddedSubtitles(videoPath)
```
- 使用 FFprobe 分析视频文件
- 检测所有字幕轨道（类型、语言、编解码器）
- 返回字幕轨道信息

#### 字幕提取方法
```javascript
function extractEmbeddedSubtitle(videoPath, subtitleIndex, outputPath)
function extractSubtitleAdvanced(videoPath, subtitleIndex, outputPath, options)
function extractEmbeddedSubtitleSimple(videoPath, subtitleIndex, outputPath)
```

#### 外部字幕检查
```javascript
async function checkExternalSubtitles(videoDir, videoName)
```
- 扫描视频文件同目录下的字幕文件
- 支持 SRT、VTT、ASS、SSA、SUB 格式
- 自动转换 SRT 到 VTT 格式

### 渲染进程 (player.html)

#### 字幕检测和加载
```javascript
function detectSubtitles()
function onSubtitlesFound(event, data)
function onEmbeddedSubtitleExtracted(event, data)
```

#### 字幕管理
```javascript
function updateVideoSubtitle(subtitleType)
function loadExternalSubtitle(subtitle)
function clearExternalSubtitles()
```

#### 用户界面
```javascript
function toggleSubtitleMenu()
function updateSubtitleMenu()
function selectSubtitle(subtitleType)
```

## 字幕格式支持

### 支持的输入格式
- **内嵌字幕**: SUBRIP、ASS、SSA、VobSub、HDMV PGS 等
- **外挂字幕**: SRT、VTT、ASS、SSA、SUB

### 输出格式
- **统一输出**: WebVTT (VTT) 格式，兼容 HTML5 video 元素

## 使用方法

1. **自动检测**: 视频加载时自动检测所有可用字幕
2. **字幕菜单**: 点击控制条中的"字幕"按钮打开字幕菜单
3. **选择字幕**: 从菜单中选择需要的字幕轨道
4. **实时切换**: 播放过程中可以随时切换不同字幕

## 快捷键

- **Ctrl + S**: 打开/关闭字幕菜单

## 字幕缓存

提取的字幕文件会被缓存到系统临时目录：
- Windows: `%TEMP%\\omniwall-subtitles\\`
- 最多保留最近 100 个提取的字幕文件
- 自动清理过期缓存

## 故障排除

### 常见问题

1. **字幕不显示**
   - 检查视频文件是否包含字幕轨道
   - 确认 FFmpeg 安装正确
   - 查看控制台日志获取详细信息

2. **字幕提取失败**
   - 某些字幕格式可能需要特定编解码器
   - 尝试使用备用提取方法

3. **字幕显示乱码**
   - 检查字幕文件编码
   - 确保字体支持相应字符集

### 调试信息

在开发者工具控制台中可以看到详细的字幕处理日志：
- 字幕检测结果
- 提取进度和状态
- 错误信息

## 依赖项

- `ffmpeg-static`: 提供 FFmpeg 二进制文件
- `fluent-ffmpeg`: FFmpeg Node.js 接口

## 配置选项

字幕提取器支持以下配置：
- 输出格式选择
- 缓存大小限制  
- 提取超时设置
- 错误重试机制