# OmniWall 重构说明

## 重构概述

已将原始的 `main.js` (约1500行) 重构为模块化架构，提高了代码的可维护性和可读性。

## 新的文件结构

### 核心模块
- **`main-refactored.js`** - 新的主入口文件，简洁明了
- **`app/app-manager.js`** - 应用管理器，负责协调所有模块
- **`config/config-manager.js`** - 配置管理，处理设置文件读写
- **`services/window-manager.js`** - 窗口管理，创建和管理各种窗口
- **`services/tv-show-scanner.js`** - 电视剧扫描器，处理文件系统扫描
- **`services/subtitle-manager.js`** - 字幕管理器，处理字幕提取和检测

## 主要改进

### 1. 模块化设计
- 每个模块职责单一，便于维护和测试
- 减少全局变量和函数依赖
- 更好的代码组织和结构

### 2. 代码复用
- 将重复的文件路径检查和目录创建逻辑统一到 `ConfigManager`
- 将文件扫描逻辑统一到 `TvShowScanner`
- 将字幕处理逻辑统一到 `SubtitleManager`

### 3. 错误处理
- 统一的错误处理策略
- 更清晰的错误日志
- 异常情况的适当处理

### 4. 内存管理
- 内存监控功能保留在 `AppManager` 中
- 更好的资源清理机制

### 5. IPC 事件处理
- IPC 事件处理逻辑集中在 `AppManager`
- 更清晰的事件响应流程
- 减少重复的 IPC 处理代码

## 迁移指南

### 从旧版本迁移
1. 备份原有的 `main.js` 文件
2. 将 `main-refactored.js` 重命名为 `main.js` 或者更新 `package.json` 中的主入口
3. 确保所有依赖模块文件存在
4. 测试应用功能

### 主要变更
- 所有功能现在通过模块化类提供
- 配置文件路径管理统一到 `ConfigManager`
- 窗口创建和管理统一到 `WindowManager`
- 文件扫描和字幕处理逻辑分别独立

## 模块说明

### ConfigManager
- 管理所有配置文件路径
- 统一的设置读写接口
- 自动创建配置目录

### WindowManager
- 窗口创建和生命周期管理
- 对话框处理
- 窗口事件监听

### TvShowScanner
- 电视剧文件夹扫描
- 季和集的组织识别
- 海报和剧集查找
- 外部字幕文件检测

### SubtitleManager
- 字幕流检测和提取
- 支持 ffmpeg 和 fluent-ffmpeg
- 字幕文件格式处理

### AppManager
- 应用主协调器
- IPC 事件分发
- 内存监控
- 应用生命周期管理

## 测试

重构后的代码已经通过模块导入测试，所有模块都能正常实例化。